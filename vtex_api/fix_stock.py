from shadow_database import DatabaseConnection
from shadow_helpers.helpers import make_dict
from shadow_vtex.vtex import try_to_request

from datetime import datetime, timedelta
from multiprocessing import Pool, Manager
import requests, json, dateutil.relativedelta

def format_int_to_float(int_value):
	str_value = str(int_value)
	return float(str_value[:-2] + '.' + str_value[-2:])

ORDER_STATUS = {
	'waiting-for-seller-confirmation': 'Aguardando confirmação do Seller',
	'order-created': 'Processando',
	'order-completed': 'Processando',
	'on-order-completed': 'Processando',
	'payment-pending': 'Pagamento Pendente',
	'waiting-for-order-authorization': 'Aguardando Autorização do Pedido',
	'approve-payment': 'Preparando entrega',
	'payment-approved': 'Pagamento Aprovado',
	'payment-denied': 'Pagamento Negado',
	'request-cancel': 'Solicitar cancelamento',
	'waiting-for-seller-decision': 'Aguardando decisão do Seller',
	'authorize-fulfillment': 'Aguardando autorização para despachar',
	'order-create-error': 'Erro na criação do pedido',
	'order-creation-error': 'Erro na criação do pedido',
	'window-to-cancel': 'Carência para Cancelamento',
	'ready-for-handling': 'Pronto para o Manuseio',
	'start-handling': 'Iniciar Manuseio',
	'handling': 'Preparando Entrega',
	'invoice-after-cancellation-deny': 'Fatura pós-cancelamento negado',
	'order-accepted': 'Verificando Envio',
	'invoice': 'Enviando',
	'invoiced': 'Faturado',
	'replaced': 'Substituído',
	'cancellation-requested': 'Cancelamento solicitado',
	'cancel': 'Cancelar',
	'canceled': 'Cancelado',
}

api_connection_file = open("api_connection.json", 'rb')
api_connection_config = json.load(api_connection_file)

def get_stock_fix_from_linx(x):
	sku = x[0] 
	fixes_dict = x[1]

	# print(sku)
	if sku['sku_id']:
		sku_id = sku['sku_id']
	else:
		get_sku_id_url = 'http://marciamello.vtexcommercestable.com.br/api/catalog_system/pvt/sku/stockkeepingunitbyean/%s' % sku['ean']
		response = try_to_request("GET", get_sku_id_url, headers=api_connection_config)
		if not response:
			return 'Sku not found'

		json_response = json.loads(response.text)
		sku_id = json_response['Id']

	fixes_dict[sku_id] = sku['stock_linx']

	# set_stock_url = 'http://logistics.vtexcommercestable.com.br/api/logistics/pvt/inventory/skus/%s/warehouses/1_1?an=marciamello' % sku_id
	# response = try_to_request("PUT", set_stock_url, headers=api_connection_config, data='{"quantity": %s}' % sku['stock_linx'])
	# print(sku)

def get_stock_fix_from_orders(x):
	sku = x[0] 
	fixes_dict = x[1]
	
	available_quantity = None
	try:
		available_quantity = fixes_dict[sku['sku_id']]
	except Exception as e:
		return

		get_stock_url = "http://logistics.vtexcommercestable.com.br/api/logistics/pvt/inventory/skus/%s?an=marciamello" % sku['sku_id']
		response = try_to_request("GET", get_stock_url, headers=api_connection_config)
		stock_info = json.loads(response.text)
		available_quantity = stock_info['balance'][0]['totalQuantity']

	true_quantity = available_quantity - sku['ordered_quantity']
	print('%s: %s -> %s' % (sku['sku_id'], available_quantity, true_quantity))

	fixes_dict[sku['sku_id']] = true_quantity

	# print('%s: %s' % (sku['sku_id'], stock_info['balance'][0]['totalQuantity']))

	# stock_infos.append([sku['sku_id'], available_quantity])
	# stock_info['balance'][0]['reservedQuantity']

def fix_stock(sku):
	sku_id = sku['sku_id']
	true_quantity = sku['true_quantity']

	if true_quantity < 0:
		print('Estoque negativo: %s (%s)' % (sku_id, true_quantity))
		true_quantity = 0
	else:
		print('%s: %s' % (sku_id, true_quantity))

	set_stock_url = 'http://logistics.vtexcommercestable.com.br/api/logistics/pvt/inventory/skus/%s/warehouses/1_1?an=marciamello' % sku_id
	response = try_to_request("PUT", set_stock_url, headers=api_connection_config, data='{"quantity": %s}' % true_quantity)

	if not response:
		print('ERROR: %s' % sku_id)

	# else:
	# 	print(response.text)

if __name__ == '__main__':
	fixes_dict = Manager().dict()
	import time
	start_time = time.time()
	dc = DatabaseConnection()

	divergence_query = """
		SELECT
			count(*) as divergences,
			sum(mudanca_detectada) as detected,
			count(*) - sum(mudanca_detectada) as undetected
		from (
			select 
				COALESCE(e.codigo_barra, vpi.ean) as ean,
				vpi.item_id,
				COALESCE(e.estoque_disponivel, 0) as linx, 
				vpi.stock_quantity as vtex,
				case when COALESCE(e.codigo_barra, vpi.ean) in (
					SELECT distinct
						ps.codigo_barra
					FROM loja_saidas ls
					INNER JOIN loja_saidas_produto lsp on lsp.ROMANEIO_PRODUTO = ls.ROMANEIO_PRODUTO
					inner join produtos_barra ps on ps.produto = lsp.produto and ps.COR_PRODUTO = lsp.COR_PRODUTO
					where 1=1
						and ls.filial = 'e-commerce'
						and case 
							when lsp.DATA_PARA_TRANSFERENCIA > ls.DATA_PARA_TRANSFERENCIA then lsp.DATA_PARA_TRANSFERENCIA
							else ls.DATA_PARA_TRANSFERENCIA 
						end >= DATEADD(day, -7, GETDATE())
					UNION
					SELECT distinct
						ps.codigo_barra
					FROM loja_entradas le
					INNER JOIN loja_entradas_produto lep on lep.ROMANEIO_PRODUTO = le.ROMANEIO_PRODUTO
					inner join produtos_barra ps on ps.produto = lep.produto and ps.COR_PRODUTO = lep.COR_PRODUTO
					where 1=1
						and le.filial = 'e-commerce'
						and case 
							when lep.DATA_PARA_TRANSFERENCIA > le.DATA_PARA_TRANSFERENCIA then lep.DATA_PARA_TRANSFERENCIA
							else le.DATA_PARA_TRANSFERENCIA 
						end >= DATEADD(day, -7, GETDATE())
					UNION
					SELECT distinct
						lvp.CODIGO_BARRA
					FROM dbo.LOJA_VENDA_PRODUTO lvp
					inner join dbo.FILIAIS fil on fil.cod_filial = lvp.codigo_filial
					INNER JOIN produtos p on lvp.produto = p.produto
					where 1=1
						and fil.filial = 'e-commerce' 
						and data_venda >= DATEADD(day, -7, GETDATE())
						and p.grupo_produto != 'GIFTCARD'
						and lvp.qtde > 0
					UNION
					SELECT
						voi.ean
					FROM dbo.bi_vtex_order_items voi 
					WHERE status not in ('Faturado', 'Cancelado')
					-- UNION
					-- SELECT distinct
					-- 	vp.CODIGO_BARRA
					-- FROM loja_venda_produto vp
					-- INNER JOIN filiais f on f.cod_filial = vp.codigo_filial
					-- where 1=1
					-- 	and f.filial = 'MM DOM PEDRO'
					-- 	and vp.DATA_VENDA >= '2018-12-21'
				) then 1 else 0 end as mudanca_detectada
			from (
				SELECT 
					codigo_barra,
					estoque_disponivel - 0 as estoque_disponivel
				FROM w_estoque_disponivel_sku
				where filial = 'e-commerce' and (estoque_disponivel - 0) > 0
			) e
			full outer join bi_vtex_product_items vpi on vpi.ean = e.codigo_barra
			where 1=1
				and COALESCE(vpi.stock_quantity, 0) != COALESCE(e.estoque_disponivel, 0)
				-- and vpi.ean = '0810001026339'
		) t
	;
	"""

	divergence_skus = dc.select(divergence_query, strip=True, dict_format=True)
	print(divergence_skus)

	STOCK_MARGIN = 0
	product_filter = """
		-- and ps.produto in ('22.05.0562','35.02.0507','22.03.0218','77.61.0123','77.99.2300','22.05.0574','22.05.0566','22.05.0571','22.03.0161','22.12.0541','22.12.0541','22.12.0541','77.22.0243','77.73.0354','35.02.0599','77.61.0107','77.61.0136','22.05.0489','35.09.0929','77.61.0139','22.05.0175','32.03.0292','32.03.0291','35.02.0786','35.02.0786','35.09.0832','22.06.0448','23.11.0186','22.05.0577','22.06.0469','22.04.0161','31.05.0005','35.09.0834','22.05.0545','19.07.0002','77.61.0106','32.06.0052','77.61.0105','22.12.0443','28.01.0052','22.02.0246')
		ps.codigo_barra in (
			-- produtos com mudanca de estoque em X dias
			SELECT distinct
				ps.codigo_barra
			FROM loja_saidas ls
			INNER JOIN loja_saidas_produto lsp on lsp.ROMANEIO_PRODUTO = ls.ROMANEIO_PRODUTO
			inner join produtos_barra ps on ps.produto = lsp.produto and ps.COR_PRODUTO = lsp.COR_PRODUTO
			where 1=1
				and ls.filial = 'e-commerce'
				and case 
					when lsp.DATA_PARA_TRANSFERENCIA > ls.DATA_PARA_TRANSFERENCIA then lsp.DATA_PARA_TRANSFERENCIA
					else ls.DATA_PARA_TRANSFERENCIA 
				end >= DATEADD(day, -7, GETDATE())
			UNION
			SELECT distinct
				ps.codigo_barra
			FROM loja_entradas le
			INNER JOIN loja_entradas_produto lep on lep.ROMANEIO_PRODUTO = le.ROMANEIO_PRODUTO
			inner join produtos_barra ps on ps.produto = lep.produto and ps.COR_PRODUTO = lep.COR_PRODUTO
			where 1=1
				and le.filial = 'e-commerce'
				and case 
					when lep.DATA_PARA_TRANSFERENCIA > le.DATA_PARA_TRANSFERENCIA then lep.DATA_PARA_TRANSFERENCIA
					else le.DATA_PARA_TRANSFERENCIA 
				end >= DATEADD(day, -7, GETDATE())
			UNION
			SELECT distinct
				lvp.CODIGO_BARRA
			FROM dbo.LOJA_VENDA_PRODUTO lvp
			inner join dbo.FILIAIS fil on fil.cod_filial = lvp.codigo_filial
			INNER JOIN produtos p on lvp.produto = p.produto
			where 1=1
				and fil.filial = 'e-commerce' 
				and lvp.data_venda >= DATEADD(day, -7, GETDATE())
				and p.grupo_produto != 'GIFTCARD'
				and lvp.qtde > 0
			UNION
			SELECT
				voi.ean
			FROM dbo.bi_vtex_order_items voi 
			WHERE status not in ('Faturado', 'Cancelado')
			UNION
			select distinct
				COALESCE(e.codigo_barra, vpi.ean) as ean
			from (
				SELECT 
					codigo_barra,
					estoque_disponivel - %(stock_margin)s as estoque_disponivel
				FROM w_estoque_disponivel_sku
				where filial = 'e-commerce' and (estoque_disponivel - %(stock_margin)s) > 0
			) e
			full outer join bi_vtex_product_items vpi on vpi.ean = e.codigo_barra
			where 1=1
				and COALESCE(vpi.stock_quantity, 0) != COALESCE(e.estoque_disponivel,0)
			-- manual
			-- UNION
			-- ps.codigo_barra in ('54521','42168','46656','46658','46899','43775','44786','44710','42128','44710','44783','46724','44784','44881','42637','43305','42518','46878','46878','46915','35187','43353','46755','44834','42510','46885','42514','46936','46936','46923','42519','47139','35164','46881','46881','46826','43346','42339','43300','43781','43791','43798','43802','43812','40835','42098','46885','46749','44712','46875','40971','46945','44719','46883','43354','44712','44869','44866','44855','44881','46903','46903','46939','42638','44680','44680','46902','44393','3607024423g','43522','44986','45338','44036','45309','45327','330201632438','43911','22050523176p','3502076910xpp','2308023801p','35080007488m','32070070488g','2207024106xpp','35010820488xpp','22050465488m','2212058306xpp','2205046406xpp','3102013410m','3501082110xpp','230802173236','3507003510m','2205047206p','37090003176m','22050536176p','35070034124p','22050523176p','22050507176p','35020787491gg','230100020138','2207025810m','2205050501m','3502077609m','35091211219m','3207006732g','2212058009g','3502078532p','22050525176p','22050495219pp','22050496219xpp','22120582155xpp','3501086103xpp','35010835178p','35010840206g','35091201155m','22120570155g','2205049310p','3501081910xpp','22120616155p','3207008120p','3207008020g','2402010110p','22070257155p','22050473155m','3302021207m','33020230485p','2207023994xpp','2205046610g','3502080510pp','2207026703g','3502080410xpp','231102630136','31050008176gg','3101014001pp','3502080610p','3502080410p','2404053110xgg','3502083303m','2215001416m','3502083303m','230802170338','3502085003p','35091212223m','3104000603m','3101015503m','3207007801p','3501080610xpp','2207022610xpp','2213006601m','2404054201g','3302021501m','3302022901p','22120609176m','2311028808m','2404054002m','2205043601m','2212056202m','22050529259g','35091209221m','2205050502g','2205047202p','2205047302m','31010147221p','3202025702xpp','3203035902m','22050524176p','22120566176m','2212056802p','2212056802p','3302020702p','3302020701m','2212056201gg','3105001502m','33020233221p','2212059794g','3502081102g','3502083302p','22120593176p','4101008601m','4101008501g','2205047001xpp','2207023901p','2205050601xpp','3502077502m','2212058401pp','2205048202g','22030241176p','2203024102m','2203024002p','3302023202m','2302002602m','330202340140','2204022810p','22020240176p','080119726334','081000143335','081000113335','08040220139','080102020237','080800150234','081000123334','0808001650237','080800160237','080800140234','08040240234','08011863335','4101011864m','41010117105m','41010095105m','4101011802m','0810001426338','2205047206m','2205047206g','081000140234','2205047207p','081000120236','08100001226336','08011923235','08040220235','08011952334','080102020234','0810001226337','080102023336','080800140235','080102020236','081100068136','4101008301g','4101011001g','4101008301p','4101009301p','4101010401g','4101010901m','2205052601g','4101010101m','2205052601g','2205052601p','4101010101g','4101010301g','4101011402p','41010117105p','4101011864m','4101012208g','4101012105g','41010121263m','4101010933m','4101010933m','4101010301g','4101010902m','41010105105m','41010095105p','22050512244p','4101012202g','35020818105p','35020847105m','3502084002pp','3502081402g','3502083902pp','3502084616p','3502084602p','3502084602m','3502083417p','3502083506p','3502083502p','35020816105g','35020815105p','3502081502g','35020816504p','2305010102p','2213006701pp','3502084601p','2205058201p','3502083901pp','2205058364p','22050517176p','2205058101p','3502085102pp','2213006702pp','2205051104g','2205051104p','22050512244m','2205058303p','3502081803p','2205058302m','2205051702P','4101009601p','22050515176m','0810001026336','081000130236','231102630144','4101012501g','2404051947m','22120363454g','22020176257gg','35010697486pp','35010612105gg','2311028808g','22050467155m','2212058401gg','3501058804m','2205035202g','3203033004m','3501080410g','4101010101m','3203033004m','35020787491m','3302023833736','35020732257g','35020815105g','35020812229xpp','22120543257xpp','2207025810xpp','22120587219xpp','2206055010pp','2205051703g','2205054405g','22050498219xgg','3105001410xgg','2404052710g','2308015502g','3509085404pp','3509085404xpp','3102012810p','3207006110m','4101012201m','3502083903pp','3502083903m','35091205218xpp','22070257155p','20030029105gg','35010853176g','3502084602gg','32070082244g','2214000803g','2205056202gg','2205054405g','35010739218PP','3501058716P','35010836454P','3502048802XPP','PR85950173525265','35091097485GG','3509105835P','35010499218PP','3509111804P','3102008202G','3509098102P','31020070223m','3102009704P','3509094904P','3502059904P','3502051905PP','34010082484PP','3501074878M','35010735216M','35020615219G','35010605218PP','3501058404M','3501041405M','350106720450','3501063604G','3501063404P','350205912738','3101059603p','35010632135M','3501086103XPP','35010582135P','3501059707PP','3501063402P','3501069302M','3501059202PP','3501063202M','3501059705PP','3501068602m','3501059705PP','23080155176P','22020201176p','3202024401M','33020190176XPP','23110232176M','2212039401XGG','20030028176M','31020089176GG','37050022135G','24030030135GG','22120458117G','22120443155M','3202023694XPP','2306004694P','2212046407M','31020070257M','3207003533XGG','23060068454P','3401001403M','22050306176XPP','2308022020P','2206045906M','22130041257PP','2212056032M','2311024432P','22030188220PP','22040156176P','28020036218XPP','22060538218M','34010075217xpp','2306004632M','2207021368P','200300312444','22030226217XPP','2801005505P','200300262436','3302018933746','3203027304P','2311023204M','3302019704G','3303002804P','330201810442','32030297460G','22040207218G','3206006204G','2311024904M','32070026218PP','35090834105PP','24040497337PP','22060494105M','32030393105p','24040501105P','23120006105P','22060469105G','3509113310550','3303003210PP','3705001602GG','22030233221XPP','3202024602M','2311020102G','22060457453GG','23110206453GG','3505004616P','22060477259P','3203025513PP','22110158220M','35010695229GG','35010752485PP','35010691217M','35010842105PP','35091207217M','35010698219XPP','35010784260XPP','3501086101XPP','35010852176P','3501084601P','35020790176P','3501086101P','3502085301G','3502084701P','35020838176GG','3509121601P','3501087301P','3501087101P','35010862176XPP','3501082702PP','3501084102G','3501083802P','3501085202M','3501073702PP','3501059202P','3501058716G','35010830454P','3501057604g','3501083704P','3501055504G','35010835178PP','35010831178P','3501044605m','3501083705P','35010598105M','35010852176G','35010692176G','35010763176G','3502074616P','4101009401P','3302023733740','231102842438','4101008501P','4101011802P','2205052601G','13207009301P','32020262176P','3705002601P','35020766176G','2213007312P','2311029012P','3501087612M','3101015412P','22150014263P','22150014117G','3502077432P','2212058510M','3502080310PP','22120616176P','2205048033GG','3302023232M','22030243194G','2212059410P','35020811263M','3101014207G','2205046107XPP','2402010310P','2205043607XGG','24040536117G','231102812442','231102812440','231102812440','2212060907P','2212056894M','3503002210M','2404054033M','31050005263G','2212058394PP','23080224206P','32020768206xpp','24040535122M','2205047004XPP','4101009204M','2206055210M','3504003210P','22150014176M','2202023801P','35020730257P','22070218257XPP','35010767257XPP','2207026605P','3502076404PP','33020231218P','2212058201XPP','3207007104P','3202025610GG','3102012908M','3709000204PP','3706001905XPP','2205046704M','3502076504XPP','3203033004XPP','3207007804M','35091205218M','37090002105M','24040540105M','2308021710536','35040034219XPP','22050498219XPP','3004010401P','35091213198M','22120616105P','35091211259P','32030330105XGG','35020812229PP','31010150229GG','31010140105PP','3105001410PP','35020764105XPP','3102012810XPP','3202025310XPP','2309009333840','21010008176P','31020125257P','22120543257PP','22020238105M','231102842436','22050506105XPP','22050506105XPP','35020770236PP','35020800217XPP','2205046105P','28060016260XPP','35010828260XPP','22070238256XPP','3302021310XPP','35020810256XPP','23080237219P','35010823219G','2404053568P','2303003133740','35020744217XPP','22050473472M','3504003710PP','2204023610PP','2212058710M','35040039219PP','3504003624M','2212056605M','35060035236P','3102013105G','35010845217P','3302023833734','28030019198P','231102812436','22130065219XPP','22150014263G','22050577507G','22050577507G','2205054664GG','2205054264GG','2205054202G','2205055002P','22050545221M','2205055002GG','2205054802P','2205055005M','22070279217P','22050575105GG','2205054605M','2205054405P','22020246231GG','2205054605G','3705002864P','3705002864G','2203024889M','2205050333XPP','2205057401P','2205054601GG','2205054189PP','2205057694G','2205054817P','2205050304XPP','37050028105M','2205054601P','37050029221PP','3302018933742','22030239206GG','230802362436','2205058201M','41010099016','0226038076','22050520076','4101009810510','220505192446','22050518036','2205051810510','220505195076','02260381766','41010100646','23050102026','22120598176M','22120598482P','2212059864G','22120598176M','22120598336P','22120602481P','2212060064P','22120602482P','2212059802M','2212059794P','2212060101P','22120598481P','22120599155M','2212060120P','22120598211M','22120598460G','22120598460P','2212060104P','2212060104P','2212060106M','0801020219435','080900030234','0801020226336','081000140237','080800140235','0810001226336','081000103337','08011940234','08011910238','08040230235','08011940235','080119033634','081000120234','08011901237','08011860338','0809000326334','3706001901P','33020216229PP','35010853176M','080118849938','081000110234','080119126336','08060770234','08011933334','081100060135','080102023336','35010833217P','080102023336','3501084207PP','35020815105M','3501058316P','32070071155G','22050496219M','22050495219M','3501072704P','45329','44569','44568','074400900U','44296','44296','43229','43297','43805','42640','42329','46922','46915','43803','44050','44648','46756','39622','44809','43344','46744','43448','46756','56231881000799','46865','44770','42341','44847','46935','42170','44712','44689','42375','46865','42360','44711','44717','43337','43353','42420','28850','46874','46874','46873','44714','42136','43361','46873','44747','42136','46865','40606','42142','43361','42102','41110','43443','43441','44574','44573','44576','45354','36357','33990','34024','42786','38880','37654','0704342105U','43863','45360','43223','44395','44303','36358','41140','37700','37701','45306','45304','41422','42887','070434202U','45134','45384','44377','39889','39888','45372','68800','3604010013U','44002','44566','44566','38564','44916','42850','42849','44916','45311','44572','43125','36356','35055','35044','42946','43426','41597','43897','43898','42872','42875','3604010402U','3601019600U','3604010013U','0704342155U','070434123U','45366','45366','41638','41636','44558','44556','074400900U','074400900U','43837','43849','44013','43972','074401100U','074401100U','46313','074400900U','44291','43850','43792','074401100U','074401100U','074401100U','44037','36410','074400900U','074400900U','44292','43801','43651','43650','070434102U','43044','43043','43969','43786','40529','074400900U','074400900U','37603','070507800U','37606','44035','45394','43877','43876','43760','0704342155U','40132','3601019600U','0704341105U','070434123U','0809000326334','074401100U','074400900U','46659','42605','070434102U','08011860338','37622','070434202U','43815','44268','7899343857982','43438','43439','41702','3601019500U','3601019100U','3601019100U','3601019400U','3601019400U','3601019300U','3601019000U','3601018900U','3601019900U','3601019800U','3601019300U','42898','42873','42898','42556','42882','37551','43410','43965','43409','36040095105U','42630','43965','42787','43865','36329','43127','42965','45209','38835','42853','42852','42851','34086','44033','44302','43868','45355','43525','37761','41646','41645','41780','37650','45566','37619','41689','43663','37611','43160','43160','43160','43160','43160','43649','43649','33006','25331','25331','25331','43645','43645','45472','41598','42615','45205','35020621218PP')
			UNION
			select codigo_barra 
			from produtos_barra
			where codigo_barra in ('54521','42168','46656','46658','46899','43775','44786','44710','42128','44710','44783','46724','44784','44881','42637','43305','42518','46878','46878','46915','35187','43353','46755','44834','42510','46885','42514','46936','46936','46923','42519','47139','35164','46881','46881','46826','43346','42339','43300','43781','43791','43798','43802','43812','40835','42098','46885','46749','44712','46875','40971','46945','44719','46883','43354','44712','44869','44866','44855','44881','46903','46903','46939','42638','44680','44680','46902','44393','3607024423g','43522','44986','45338','44036','45309','45327','330201632438','43911','22050523176p','3502076910xpp','2308023801p','35080007488m','32070070488g','2207024106xpp','35010820488xpp','22050465488m','2212058306xpp','2205046406xpp','3102013410m','3501082110xpp','230802173236','3507003510m','2205047206p','37090003176m','22050536176p','35070034124p','22050523176p','22050507176p','35020787491gg','230100020138','2207025810m','2205050501m','3502077609m','35091211219m','3207006732g','2212058009g','3502078532p','22050525176p','22050495219pp','22050496219xpp','22120582155xpp','3501086103xpp','35010835178p','35010840206g','35091201155m','22120570155g','2205049310p','3501081910xpp','22120616155p','3207008120p','3207008020g','2402010110p','22070257155p','22050473155m','3302021207m','33020230485p','2207023994xpp','2205046610g','3502080510pp','2207026703g','3502080410xpp','231102630136','31050008176gg','3101014001pp','3502080610p','3502080410p','2404053110xgg','3502083303m','2215001416m','3502083303m','230802170338','3502085003p','35091212223m','3104000603m','3101015503m','3207007801p','3501080610xpp','2207022610xpp','2213006601m','2404054201g','3302021501m','3302022901p','22120609176m','2311028808m','2404054002m','2205043601m','2212056202m','22050529259g','35091209221m','2205050502g','2205047202p','2205047302m','31010147221p','3202025702xpp','3203035902m','22050524176p','22120566176m','2212056802p','2212056802p','3302020702p','3302020701m','2212056201gg','3105001502m','33020233221p','2212059794g','3502081102g','3502083302p','22120593176p','4101008601m','4101008501g','2205047001xpp','2207023901p','2205050601xpp','3502077502m','2212058401pp','2205048202g','22030241176p','2203024102m','2203024002p','3302023202m','2302002602m','330202340140','2204022810p','22020240176p','080119726334','081000143335','081000113335','08040220139','080102020237','080800150234','081000123334','0808001650237','080800160237','080800140234','08040240234','08011863335','4101011864m','41010117105m','41010095105m','4101011802m','0810001426338','2205047206m','2205047206g','081000140234','2205047207p','081000120236','08100001226336','08011923235','08040220235','08011952334','080102020234','0810001226337','080102023336','080800140235','080102020236','081100068136','4101008301g','4101011001g','4101008301p','4101009301p','4101010401g','4101010901m','2205052601g','4101010101m','2205052601g','2205052601p','4101010101g','4101010301g','4101011402p','41010117105p','4101011864m','4101012208g','4101012105g','41010121263m','4101010933m','4101010933m','4101010301g','4101010902m','41010105105m','41010095105p','22050512244p','4101012202g','35020818105p','35020847105m','3502084002pp','3502081402g','3502083902pp','3502084616p','3502084602p','3502084602m','3502083417p','3502083506p','3502083502p','35020816105g','35020815105p','3502081502g','35020816504p','2305010102p','2213006701pp','3502084601p','2205058201p','3502083901pp','2205058364p','22050517176p','2205058101p','3502085102pp','2213006702pp','2205051104g','2205051104p','22050512244m','2205058303p','3502081803p','2205058302m','2205051702P','4101009601p','22050515176m','0810001026336','081000130236','231102630144','4101012501g','2404051947m','22120363454g','22020176257gg','35010697486pp','35010612105gg','2311028808g','22050467155m','2212058401gg','3501058804m','2205035202g','3203033004m','3501080410g','4101010101m','3203033004m','35020787491m','3302023833736','35020732257g','35020815105g','35020812229xpp','22120543257xpp','2207025810xpp','22120587219xpp','2206055010pp','2205051703g','2205054405g','22050498219xgg','3105001410xgg','2404052710g','2308015502g','3509085404pp','3509085404xpp','3102012810p','3207006110m','4101012201m','3502083903pp','3502083903m','35091205218xpp','22070257155p','20030029105gg','35010853176g','3502084602gg','32070082244g','2214000803g','2205056202gg','2205054405g','35010739218PP','3501058716P','35010836454P','3502048802XPP','PR85950173525265','35091097485GG','3509105835P','35010499218PP','3509111804P','3102008202G','3509098102P','31020070223m','3102009704P','3509094904P','3502059904P','3502051905PP','34010082484PP','3501074878M','35010735216M','35020615219G','35010605218PP','3501058404M','3501041405M','350106720450','3501063604G','3501063404P','350205912738','3101059603p','35010632135M','3501086103XPP','35010582135P','3501059707PP','3501063402P','3501069302M','3501059202PP','3501063202M','3501059705PP','3501068602m','3501059705PP','23080155176P','22020201176p','3202024401M','33020190176XPP','23110232176M','2212039401XGG','20030028176M','31020089176GG','37050022135G','24030030135GG','22120458117G','22120443155M','3202023694XPP','2306004694P','2212046407M','31020070257M','3207003533XGG','23060068454P','3401001403M','22050306176XPP','2308022020P','2206045906M','22130041257PP','2212056032M','2311024432P','22030188220PP','22040156176P','28020036218XPP','22060538218M','34010075217xpp','2306004632M','2207021368P','200300312444','22030226217XPP','2801005505P','200300262436','3302018933746','3203027304P','2311023204M','3302019704G','3303002804P','330201810442','32030297460G','22040207218G','3206006204G','2311024904M','32070026218PP','35090834105PP','24040497337PP','22060494105M','32030393105p','24040501105P','23120006105P','22060469105G','3509113310550','3303003210PP','3705001602GG','22030233221XPP','3202024602M','2311020102G','22060457453GG','23110206453GG','3505004616P','22060477259P','3203025513PP','22110158220M','35010695229GG','35010752485PP','35010691217M','35010842105PP','35091207217M','35010698219XPP','35010784260XPP','3501086101XPP','35010852176P','3501084601P','35020790176P','3501086101P','3502085301G','3502084701P','35020838176GG','3509121601P','3501087301P','3501087101P','35010862176XPP','3501082702PP','3501084102G','3501083802P','3501085202M','3501073702PP','3501059202P','3501058716G','35010830454P','3501057604g','3501083704P','3501055504G','35010835178PP','35010831178P','3501044605m','3501083705P','35010598105M','35010852176G','35010692176G','35010763176G','3502074616P','4101009401P','3302023733740','231102842438','4101008501P','4101011802P','2205052601G','13207009301P','32020262176P','3705002601P','35020766176G','2213007312P','2311029012P','3501087612M','3101015412P','22150014263P','22150014117G','3502077432P','2212058510M','3502080310PP','22120616176P','2205048033GG','3302023232M','22030243194G','2212059410P','35020811263M','3101014207G','2205046107XPP','2402010310P','2205043607XGG','24040536117G','231102812442','231102812440','231102812440','2212060907P','2212056894M','3503002210M','2404054033M','31050005263G','2212058394PP','23080224206P','32020768206xpp','24040535122M','2205047004XPP','4101009204M','2206055210M','3504003210P','22150014176M','2202023801P','35020730257P','22070218257XPP','35010767257XPP','2207026605P','3502076404PP','33020231218P','2212058201XPP','3207007104P','3202025610GG','3102012908M','3709000204PP','3706001905XPP','2205046704M','3502076504XPP','3203033004XPP','3207007804M','35091205218M','37090002105M','24040540105M','2308021710536','35040034219XPP','22050498219XPP','3004010401P','35091213198M','22120616105P','35091211259P','32030330105XGG','35020812229PP','31010150229GG','31010140105PP','3105001410PP','35020764105XPP','3102012810XPP','3202025310XPP','2309009333840','21010008176P','31020125257P','22120543257PP','22020238105M','231102842436','22050506105XPP','22050506105XPP','35020770236PP','35020800217XPP','2205046105P','28060016260XPP','35010828260XPP','22070238256XPP','3302021310XPP','35020810256XPP','23080237219P','35010823219G','2404053568P','2303003133740','35020744217XPP','22050473472M','3504003710PP','2204023610PP','2212058710M','35040039219PP','3504003624M','2212056605M','35060035236P','3102013105G','35010845217P','3302023833734','28030019198P','231102812436','22130065219XPP','22150014263G','22050577507G','22050577507G','2205054664GG','2205054264GG','2205054202G','2205055002P','22050545221M','2205055002GG','2205054802P','2205055005M','22070279217P','22050575105GG','2205054605M','2205054405P','22020246231GG','2205054605G','3705002864P','3705002864G','2203024889M','2205050333XPP','2205057401P','2205054601GG','2205054189PP','2205057694G','2205054817P','2205050304XPP','37050028105M','2205054601P','37050029221PP','3302018933742','22030239206GG','230802362436','2205058201M','41010099016','0226038076','22050520076','4101009810510','220505192446','22050518036','2205051810510','220505195076','02260381766','41010100646','23050102026','22120598176M','22120598482P','2212059864G','22120598176M','22120598336P','22120602481P','2212060064P','22120602482P','2212059802M','2212059794P','2212060101P','22120598481P','22120599155M','2212060120P','22120598211M','22120598460G','22120598460P','2212060104P','2212060104P','2212060106M','0801020219435','080900030234','0801020226336','081000140237','080800140235','0810001226336','081000103337','08011940234','08011910238','08040230235','08011940235','080119033634','081000120234','08011901237','08011860338','0809000326334','3706001901P','33020216229PP','35010853176M','080118849938','081000110234','080119126336','08060770234','08011933334','081100060135','080102023336','35010833217P','080102023336','3501084207PP','35020815105M','3501058316P','32070071155G','22050496219M','22050495219M','3501072704P','45329','44569','44568','074400900U','44296','44296','43229','43297','43805','42640','42329','46922','46915','43803','44050','44648','46756','39622','44809','43344','46744','43448','46756','56231881000799','46865','44770','42341','44847','46935','42170','44712','44689','42375','46865','42360','44711','44717','43337','43353','42420','28850','46874','46874','46873','44714','42136','43361','46873','44747','42136','46865','40606','42142','43361','42102','41110','43443','43441','44574','44573','44576','45354','36357','33990','34024','42786','38880','37654','0704342105U','43863','45360','43223','44395','44303','36358','41140','37700','37701','45306','45304','41422','42887','070434202U','45134','45384','44377','39889','39888','45372','68800','3604010013U','44002','44566','44566','38564','44916','42850','42849','44916','45311','44572','43125','36356','35055','35044','42946','43426','41597','43897','43898','42872','42875','3604010402U','3601019600U','3604010013U','0704342155U','070434123U','45366','45366','41638','41636','44558','44556','074400900U','074400900U','43837','43849','44013','43972','074401100U','074401100U','46313','074400900U','44291','43850','43792','074401100U','074401100U','074401100U','44037','36410','074400900U','074400900U','44292','43801','43651','43650','070434102U','43044','43043','43969','43786','40529','074400900U','074400900U','37603','070507800U','37606','44035','45394','43877','43876','43760','0704342155U','40132','3601019600U','0704341105U','070434123U','0809000326334','074401100U','074400900U','46659','42605','070434102U','08011860338','37622','070434202U','43815','44268','7899343857982','43438','43439','41702','3601019500U','3601019100U','3601019100U','3601019400U','3601019400U','3601019300U','3601019000U','3601018900U','3601019900U','3601019800U','3601019300U','42898','42873','42898','42556','42882','37551','43410','43965','43409','36040095105U','42630','43965','42787','43865','36329','43127','42965','45209','38835','42853','42852','42851','34086','44033','44302','43868','45355','43525','37761','41646','41645','41780','37650','45566','37619','41689','43663','37611','43160','43160','43160','43160','43160','43649','43649','33006','25331','25331','25331','43645','43645','45472','41598','42615','45205','35020621218PP')
	)
	""" % {'stock_margin': STOCK_MARGIN}

	linx_stock_query = """
		SELECT
			ps.codigo_barra as ean,
			vpi.item_id as sku_id,
			COALESCE(e.estoque_disponivel - 0, 0) as real_stock,
			case
					when vitrine.codigo_barra is not null
							then 
								case when COALESCE(e.estoque_disponivel-1, 0) > 0 then COALESCE(e.estoque_disponivel-1, 0)
								else 0
							end
					else
							COALESCE(e.estoque_disponivel - 0, 0)
			end as stock_linx
		from produtos_barra ps
		INNER JOIN w_estoque_disponivel_sku e on ps.codigo_barra = e.codigo_barra and e.filial = 'e-commerce' and e.estoque_disponivel > 0
		LEFT JOIN bi_vtex_product_items vpi on ps.codigo_barra = vpi.ean
		LEFT JOIN (
			select codigo_barra 
			from produtos_barra 
			where codigo_barra in ('54521','42168','46656','46658','46899','43775','44786','44710','42128','44710','44783','46724','44784','44881','42637','43305','42518','46878','46878','46915','35187','43353','46755','44834','42510','46885','42514','46936','46936','46923','42519','47139','35164','46881','46881','46826','43346','42339','43300','43781','43791','43798','43802','43812','40835','42098','46885','46749','44712','46875','40971','46945','44719','46883','43354','44712','44869','44866','44855','44881','46903','46903','46939','42638','44680','44680','46902','44393','3607024423g','43522','44986','45338','44036','45309','45327','330201632438','43911','22050523176p','3502076910xpp','2308023801p','35080007488m','32070070488g','2207024106xpp','35010820488xpp','22050465488m','2212058306xpp','2205046406xpp','3102013410m','3501082110xpp','230802173236','3507003510m','2205047206p','37090003176m','22050536176p','35070034124p','22050523176p','22050507176p','35020787491gg','230100020138','2207025810m','2205050501m','3502077609m','35091211219m','3207006732g','2212058009g','3502078532p','22050525176p','22050495219pp','22050496219xpp','22120582155xpp','3501086103xpp','35010835178p','35010840206g','35091201155m','22120570155g','2205049310p','3501081910xpp','22120616155p','3207008120p','3207008020g','2402010110p','22070257155p','22050473155m','3302021207m','33020230485p','2207023994xpp','2205046610g','3502080510pp','2207026703g','3502080410xpp','231102630136','31050008176gg','3101014001pp','3502080610p','3502080410p','2404053110xgg','3502083303m','2215001416m','3502083303m','230802170338','3502085003p','35091212223m','3104000603m','3101015503m','3207007801p','3501080610xpp','2207022610xpp','2213006601m','2404054201g','3302021501m','3302022901p','22120609176m','2311028808m','2404054002m','2205043601m','2212056202m','22050529259g','35091209221m','2205050502g','2205047202p','2205047302m','31010147221p','3202025702xpp','3203035902m','22050524176p','22120566176m','2212056802p','2212056802p','3302020702p','3302020701m','2212056201gg','3105001502m','33020233221p','2212059794g','3502081102g','3502083302p','22120593176p','4101008601m','4101008501g','2205047001xpp','2207023901p','2205050601xpp','3502077502m','2212058401pp','2205048202g','22030241176p','2203024102m','2203024002p','3302023202m','2302002602m','330202340140','2204022810p','22020240176p','080119726334','081000143335','081000113335','08040220139','080102020237','080800150234','081000123334','0808001650237','080800160237','080800140234','08040240234','08011863335','4101011864m','41010117105m','41010095105m','4101011802m','0810001426338','2205047206m','2205047206g','081000140234','2205047207p','081000120236','08100001226336','08011923235','08040220235','08011952334','080102020234','0810001226337','080102023336','080800140235','080102020236','081100068136','4101008301g','4101011001g','4101008301p','4101009301p','4101010401g','4101010901m','2205052601g','4101010101m','2205052601g','2205052601p','4101010101g','4101010301g','4101011402p','41010117105p','4101011864m','4101012208g','4101012105g','41010121263m','4101010933m','4101010933m','4101010301g','4101010902m','41010105105m','41010095105p','22050512244p','4101012202g','35020818105p','35020847105m','3502084002pp','3502081402g','3502083902pp','3502084616p','3502084602p','3502084602m','3502083417p','3502083506p','3502083502p','35020816105g','35020815105p','3502081502g','35020816504p','2305010102p','2213006701pp','3502084601p','2205058201p','3502083901pp','2205058364p','22050517176p','2205058101p','3502085102pp','2213006702pp','2205051104g','2205051104p','22050512244m','2205058303p','3502081803p','2205058302m','2205051702P','4101009601p','22050515176m','0810001026336','081000130236','231102630144','4101012501g','2404051947m','22120363454g','22020176257gg','35010697486pp','35010612105gg','2311028808g','22050467155m','2212058401gg','3501058804m','2205035202g','3203033004m','3501080410g','4101010101m','3203033004m','35020787491m','3302023833736','35020732257g','35020815105g','35020812229xpp','22120543257xpp','2207025810xpp','22120587219xpp','2206055010pp','2205051703g','2205054405g','22050498219xgg','3105001410xgg','2404052710g','2308015502g','3509085404pp','3509085404xpp','3102012810p','3207006110m','4101012201m','3502083903pp','3502083903m','35091205218xpp','22070257155p','20030029105gg','35010853176g','3502084602gg','32070082244g','2214000803g','2205056202gg','2205054405g','35010739218PP','3501058716P','35010836454P','3502048802XPP','PR85950173525265','35091097485GG','3509105835P','35010499218PP','3509111804P','3102008202G','3509098102P','31020070223m','3102009704P','3509094904P','3502059904P','3502051905PP','34010082484PP','3501074878M','35010735216M','35020615219G','35010605218PP','3501058404M','3501041405M','350106720450','3501063604G','3501063404P','350205912738','3101059603p','35010632135M','3501086103XPP','35010582135P','3501059707PP','3501063402P','3501069302M','3501059202PP','3501063202M','3501059705PP','3501068602m','3501059705PP','23080155176P','22020201176p','3202024401M','33020190176XPP','23110232176M','2212039401XGG','20030028176M','31020089176GG','37050022135G','24030030135GG','22120458117G','22120443155M','3202023694XPP','2306004694P','2212046407M','31020070257M','3207003533XGG','23060068454P','3401001403M','22050306176XPP','2308022020P','2206045906M','22130041257PP','2212056032M','2311024432P','22030188220PP','22040156176P','28020036218XPP','22060538218M','34010075217xpp','2306004632M','2207021368P','200300312444','22030226217XPP','2801005505P','200300262436','3302018933746','3203027304P','2311023204M','3302019704G','3303002804P','330201810442','32030297460G','22040207218G','3206006204G','2311024904M','32070026218PP','35090834105PP','24040497337PP','22060494105M','32030393105p','24040501105P','23120006105P','22060469105G','3509113310550','3303003210PP','3705001602GG','22030233221XPP','3202024602M','2311020102G','22060457453GG','23110206453GG','3505004616P','22060477259P','3203025513PP','22110158220M','35010695229GG','35010752485PP','35010691217M','35010842105PP','35091207217M','35010698219XPP','35010784260XPP','3501086101XPP','35010852176P','3501084601P','35020790176P','3501086101P','3502085301G','3502084701P','35020838176GG','3509121601P','3501087301P','3501087101P','35010862176XPP','3501082702PP','3501084102G','3501083802P','3501085202M','3501073702PP','3501059202P','3501058716G','35010830454P','3501057604g','3501083704P','3501055504G','35010835178PP','35010831178P','3501044605m','3501083705P','35010598105M','35010852176G','35010692176G','35010763176G','3502074616P','4101009401P','3302023733740','231102842438','4101008501P','4101011802P','2205052601G','13207009301P','32020262176P','3705002601P','35020766176G','2213007312P','2311029012P','3501087612M','3101015412P','22150014263P','22150014117G','3502077432P','2212058510M','3502080310PP','22120616176P','2205048033GG','3302023232M','22030243194G','2212059410P','35020811263M','3101014207G','2205046107XPP','2402010310P','2205043607XGG','24040536117G','231102812442','231102812440','231102812440','2212060907P','2212056894M','3503002210M','2404054033M','31050005263G','2212058394PP','23080224206P','32020768206xpp','24040535122M','2205047004XPP','4101009204M','2206055210M','3504003210P','22150014176M','2202023801P','35020730257P','22070218257XPP','35010767257XPP','2207026605P','3502076404PP','33020231218P','2212058201XPP','3207007104P','3202025610GG','3102012908M','3709000204PP','3706001905XPP','2205046704M','3502076504XPP','3203033004XPP','3207007804M','35091205218M','37090002105M','24040540105M','2308021710536','35040034219XPP','22050498219XPP','3004010401P','35091213198M','22120616105P','35091211259P','32030330105XGG','35020812229PP','31010150229GG','31010140105PP','3105001410PP','35020764105XPP','3102012810XPP','3202025310XPP','2309009333840','21010008176P','31020125257P','22120543257PP','22020238105M','231102842436','22050506105XPP','22050506105XPP','35020770236PP','35020800217XPP','2205046105P','28060016260XPP','35010828260XPP','22070238256XPP','3302021310XPP','35020810256XPP','23080237219P','35010823219G','2404053568P','2303003133740','35020744217XPP','22050473472M','3504003710PP','2204023610PP','2212058710M','35040039219PP','3504003624M','2212056605M','35060035236P','3102013105G','35010845217P','3302023833734','28030019198P','231102812436','22130065219XPP','22150014263G','22050577507G','22050577507G','2205054664GG','2205054264GG','2205054202G','2205055002P','22050545221M','2205055002GG','2205054802P','2205055005M','22070279217P','22050575105GG','2205054605M','2205054405P','22020246231GG','2205054605G','3705002864P','3705002864G','2203024889M','2205050333XPP','2205057401P','2205054601GG','2205054189PP','2205057694G','2205054817P','2205050304XPP','37050028105M','2205054601P','37050029221PP','3302018933742','22030239206GG','230802362436','2205058201M','41010099016','0226038076','22050520076','4101009810510','220505192446','22050518036','2205051810510','220505195076','02260381766','41010100646','23050102026','22120598176M','22120598482P','2212059864G','22120598176M','22120598336P','22120602481P','2212060064P','22120602482P','2212059802M','2212059794P','2212060101P','22120598481P','22120599155M','2212060120P','22120598211M','22120598460G','22120598460P','2212060104P','2212060104P','2212060106M','0801020219435','080900030234','0801020226336','081000140237','080800140235','0810001226336','081000103337','08011940234','08011910238','08040230235','08011940235','080119033634','081000120234','08011901237','08011860338','0809000326334','3706001901P','33020216229PP','35010853176M','080118849938','081000110234','080119126336','08060770234','08011933334','081100060135','080102023336','35010833217P','080102023336','3501084207PP','35020815105M','3501058316P','32070071155G','22050496219M','22050495219M','3501072704P','45329','44569','44568','074400900U','44296','44296','43229','43297','43805','42640','42329','46922','46915','43803','44050','44648','46756','39622','44809','43344','46744','43448','46756','56231881000799','46865','44770','42341','44847','46935','42170','44712','44689','42375','46865','42360','44711','44717','43337','43353','42420','28850','46874','46874','46873','44714','42136','43361','46873','44747','42136','46865','40606','42142','43361','42102','41110','43443','43441','44574','44573','44576','45354','36357','33990','34024','42786','38880','37654','0704342105U','43863','45360','43223','44395','44303','36358','41140','37700','37701','45306','45304','41422','42887','070434202U','45134','45384','44377','39889','39888','45372','68800','3604010013U','44002','44566','44566','38564','44916','42850','42849','44916','45311','44572','43125','36356','35055','35044','42946','43426','41597','43897','43898','42872','42875','3604010402U','3601019600U','3604010013U','0704342155U','070434123U','45366','45366','41638','41636','44558','44556','074400900U','074400900U','43837','43849','44013','43972','074401100U','074401100U','46313','074400900U','44291','43850','43792','074401100U','074401100U','074401100U','44037','36410','074400900U','074400900U','44292','43801','43651','43650','070434102U','43044','43043','43969','43786','40529','074400900U','074400900U','37603','070507800U','37606','44035','45394','43877','43876','43760','0704342155U','40132','3601019600U','0704341105U','070434123U','0809000326334','074401100U','074400900U','46659','42605','070434102U','08011860338','37622','070434202U','43815','44268','7899343857982','43438','43439','41702','3601019500U','3601019100U','3601019100U','3601019400U','3601019400U','3601019300U','3601019000U','3601018900U','3601019900U','3601019800U','3601019300U','42898','42873','42898','42556','42882','37551','43410','43965','43409','36040095105U','42630','43965','42787','43865','36329','43127','42965','45209','38835','42853','42852','42851','34086','44033','44302','43868','45355','43525','37761','41646','41645','41780','37650','45566','37619','41689','43663','37611','43160','43160','43160','43160','43160','43649','43649','33006','25331','25331','25331','43645','43645','45472','41598','42615','45205','35020621218PP')
		) vitrine on vitrine.codigo_barra = ps.codigo_barra
		where 1=1
			and (%(product_filter)s)
			-- and ps.codigo_barra = '080800140234'
		;
	""" % {
		'product_filter': product_filter
	}

	skus_with_different_stock = dc.select(linx_stock_query, strip=True, dict_format=True)
	# raise Exception(skus_with_different_stock)

	# skus_with_different_stock = skus_with_different_stock[0:10]
	with Pool(20) as p:
		errors = p.map(get_stock_fix_from_linx, [(x, fixes_dict) for x in skus_with_different_stock])

	dc = DatabaseConnection()
	skus_to_reduce = dc.select("""
		SELECT 
			voi.vtex_sku as sku_id,
			voi.quantity as ordered_quantity,
			voi.status as status
		from dbo.bi_vtex_order_items voi 
		where voi.status not in ('Faturado', 'Cancelado')
			and voi.created_at > '2018-12-26 10:03:33'
			-- and ean like '24040521%'
		order by voi.order_sequence
		;
	""", strip=True, dict_format=True)

	# skus_to_reduce = skus_to_reduce[0:10]

	skus_to_reduce = make_dict(skus_to_reduce, 'ordered_quantity', ['sku_id'], repeated_key='sum')
	skus_to_reduce = [{'sku_id': sku_id, 'ordered_quantity': qnt} for sku_id, qnt in skus_to_reduce.items()]

	with Pool(20) as p:
		errors = p.map(get_stock_fix_from_orders, [(x, fixes_dict) for x in skus_to_reduce])

	with Pool(20) as p:
		errors = p.map(fix_stock, [{'sku_id': sku_id, 'true_quantity': qnt} for sku_id, qnt in fixes_dict.items()])

	# for x in [{'sku_id': sku_id, 'true_quantity': qnt} for sku_id, qnt in fixes_dict.items()]:
	# 	errors = fix_stock(x)

	end_time = time.time()

	print('Total fixes: %s' % len(fixes_dict))
	print(end_time-start_time)


	# print('	vtex_stock_backup2')
	# dc.execute('TRUNCATE TABLE vtex_stock_backup2;')
	# dc.insert('vtex_stock_backup2', stock_infos, print_only=False)